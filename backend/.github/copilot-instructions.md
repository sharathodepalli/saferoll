# SafeRoll AI Instructions

1. **Source of truth** lives in `PROMPT 1 â€” Backend (FastAPI).txt` and `ðŸ“˜ SAFEROLL - COMPLETE PROJECT DOCUMENTATION.txt`; read them before coding and mirror the exact folder layout under `backend/app` (routers, policy, store, schemas, tests).
2. **Core architecture**: FastAPI app (`app/main.py`) mounting three routers (`routes/health.py`, `routes/rollout.py`, `routes/metrics.py`), in-memory store (`store.py`) tracking rollouts + per-ring deques, policy engine (`policy.py`) enforcing SLO gates, and metrics helpers (`metrics.py`) powering `/v1/metrics`.
3. **Rings + thresholds** are fixed: `pilot â†’ five â†’ twentyfive â†’ all`, evaluated over the last 5 minutes with `boot_success_rate â‰¥ 0.995`, `crash_free_median â‰¥ 0.990`, `checkin_ms_median â‰¤ 500`; automatic rollback when `crash_free < 0.950` or `boot_success_rate < 0.970`.
4. **State + storage conventions**: keep per-ring windows as `collections.deque(maxlen=...)` storing `(ts, Health)` and prune entries older than 300 seconds; a single `Store` class should own rollouts, events (decisions), cooldown timestamps, and provide helpers like `append_event`, `active_rollout`, `current_ring_events`.
5. **Schemas** defined in the prompt must be implemented verbatim in `app/schemas.py`; treat them as the API contract and reuse across routes/tests.
6. **Endpoints**: `/v1/checkin` (records event, recomputes metrics, auto-pause on breach), `/v1/rollouts` CRUD + `/promote|/pause|/rollback`, `/v1/metrics`, optional `/v1/should_promote`; responses must include decision snapshots (see Decision schema) and ring indices from `rings.py` helpers.
7. **Decision logging**: every pause/promote/rollback writes a `Decision` entry with `snapshot` metrics; keep the latest 10 decisions available for `/v1/rollouts/{id}` and broadcast-style hooks can be stubbed for now.
8. **Tooling expectations**: create `pyproject.toml` (FastAPI, uvicorn[standard], pydantic, python-dotenv, pytest, black, ruff), a slim `Dockerfile` exposing 8000, and `Makefile` targets (`run-backend`, `run-frontend`, `run-sim`, `demo`).
9. **Run workflow**: prefer `make run-backend` (internally `uvicorn app.main:app --reload --port 8000`), keep CORS open to `http://localhost:5173`, and ship a docker-compose at repo root wiring backend/frontend/sim with ports `8000/5173`.
10. **Testing**: add `app/tests/test_policy.py` that covers (a) green window returns promote, (b) crash_free < 0.990 pauses, (c) auto-rollback guard (<0.950 crash_free or boot_success < 0.970), and (d) cooldown blocks rapid double-promote; use pytest + dependency injection over the in-memory store/policy.
11. **Metrics math**: `boot_success = successes/total`, `crash_free_median = statistics.median(values)`, `checkin_ms_median` likewise; guard against empty windows by returning healthy defaults and flagging `breaches: List[str]` describing which gates failed.
12. **Promotion rules**: `policy.can_promote()` must ensure window health is green _and_ `now - last_promote_ts â‰¥ 120s`; expose `/v1/rollouts/{id}/should_promote` that surfaces decision + metrics so the frontend or sim can poll.
13. **Auto-rollback**: when critical thresholds hit, set `target_version = last_known_good`, push `Decision(kind="ROLLBACK")`, keep rollout `state="active"` but reset `ring_index` as appropriate, and update store so future check-ins reference the reverted target.
14. **Observability hooks**: maintain an append-only event log (PROMOTE/PAUSE/ROLLBACK/ADVISE_NO) under store so later WebSocket broadcasting can simply tap into `store.events[-N:]`; timestamps should be ISO8601 strings via `datetime.utcnow().isoformat()`.
15. **Assumptions**: treat all time as UTC, use simple dict-based policy config in `CheckinRes.apply` (`{"target_version": <ver or None>, "config_delta": None}`), and default `next_check_seconds` to `30` unless spec says otherwise.
16. **Frontend/Sim integration notes**: backend must allow `http://localhost:5173` and expect simulator POSTs every 5 seconds; when returning check-in responses, keep payload lightweight so the sim can parse quickly.
17. **Documentation deliverables**: add `app/README.md` with run commands, sample curl for `/v1/checkin`, `/v1/metrics`, `/v1/rollouts/.../promote`, plus an "Assumptions" section if you diverge from docs; mention these commands in the README after verifying locally.
18. **Future-ready**: structure code so swapping the in-memory store with Postgres later only requires changing `store.py`; keep business rules in `policy.py` (no inline policy decisions inside routers) to ease future unit testing.
19. **Common pitfalls** to avoid: forgetting to purge stale deque entries (breaks rolling window), promoting while paused, or returning nullable fields that violate schema defaultsâ€”lean on Pydantic validation and explicit `Optional` annotations.
20. **When unsure**, re-read the spec docsâ€”do not invent endpoints or rings beyond the four defined ones, and always favor safety (pause vs promote) unless metrics decisively pass.
